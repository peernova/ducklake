# name: test/sql/checkpoint/checkpoint_updates_interleaved.test
# description: Test checkpoint while interleaving updates in the same transaction
# group: [checkpoint]

require ducklake

require parquet

require icu

statement ok
ATTACH 'ducklake:__TEST_DIR__/checkpoint_updates_interleaved.db' AS ducklake (DATA_PATH '__TEST_DIR__/checkpoint_updates_interleaved', DATA_INLINING_ROW_LIMIT 5)

statement ok
use ducklake

statement ok
CALL ducklake.set_option('expire_older_than', '1 week');

statement ok
CALL ducklake.set_option('delete_older_than', '1 week');

statement ok
CREATE TABLE test(i INTEGER)

statement ok
INSERT INTO test FROM range(10)

statement ok
CHECKPOINT;

# Lets not allow this
statement ok
BEGIN;

statement ok
CHECKPOINT;

statement ok
COMMIT;

statement ok
BEGIN;

statement ok
INSERT INTO test FROM range(10,13)

statement ok
CALL ducklake_cleanup();

statement ok
CALL ducklake_compact();


statement ok
COMMIT;

query I
FROM test;
----
0
1
2
3
4
5
6
7
8
9
10
11
12

statement ok
BEGIN;

statement ok
CALL ducklake_cleanup();

statement ok
CALL ducklake_compact();

statement ok
INSERT INTO test FROM range(13,16)

statement ok
CALL ducklake_cleanup();

statement ok
CALL ducklake_compact();

statement ok
INSERT INTO test FROM range(17,25)

statement ok
COMMIT;

query I
FROM test;
----
0
1
2
3
4
5
6
7
8
9
10
11
12
17
18
19
20
21
22
23
24
13
14
15

statement ok
BEGIN;

statement ok
delete from test where i < 15;

statement ok
CALL ducklake_cleanup();

statement ok
CALL ducklake_compact();

statement ok
INSERT INTO test FROM range(1,3)

statement ok
CALL ducklake_cleanup();

statement ok
CALL ducklake_compact();

statement error
COMMIT;
----
Transactions can either make changes OR perform compaction - not both

